!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=5)}([function(t,e){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(t){"object"==typeof window&&(i=window)}t.exports=i},function(t,e,i){(function(t,e){var i=new Object;"undefined"==typeof window&&t&&(t.window={performance:{now:function(t){if(!t)return Date.now();var e=Date.now(t);return Math.round(1e3*e[0]+e[1]/1e6)}},requestAnimationFrame:function(t){e(()=>t(this.performance.now()))}}),window.cg=i}).call(this,i(0),i(2).setImmediate)},function(t,e,i){(function(t){var s=void 0!==t&&t||"undefined"!=typeof self&&self||window,n=Function.prototype.apply;function o(t,e){this._id=t,this._clearFn=e}e.setTimeout=function(){return new o(n.call(setTimeout,s,arguments),clearTimeout)},e.setInterval=function(){return new o(n.call(setInterval,s,arguments),clearInterval)},e.clearTimeout=e.clearInterval=function(t){t&&t.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(s,this._id)},e.enroll=function(t,e){clearTimeout(t._idleTimeoutId),t._idleTimeout=e},e.unenroll=function(t){clearTimeout(t._idleTimeoutId),t._idleTimeout=-1},e._unrefActive=e.active=function(t){clearTimeout(t._idleTimeoutId);var e=t._idleTimeout;e>=0&&(t._idleTimeoutId=setTimeout(function(){t._onTimeout&&t._onTimeout()},e))},i(3),e.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==t&&t.setImmediate||this&&this.setImmediate,e.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==t&&t.clearImmediate||this&&this.clearImmediate}).call(this,i(0))},function(t,e,i){(function(t,e){!function(t,i){"use strict";if(!t.setImmediate){var s,n,o,r,a,h=1,l={},c=!1,u=t.document,p=Object.getPrototypeOf&&Object.getPrototypeOf(t);p=p&&p.setTimeout?p:t,"[object process]"==={}.toString.call(t.process)?s=function(t){e.nextTick(function(){f(t)})}:!function(){if(t.postMessage&&!t.importScripts){var e=!0,i=t.onmessage;return t.onmessage=function(){e=!1},t.postMessage("","*"),t.onmessage=i,e}}()?t.MessageChannel?((o=new MessageChannel).port1.onmessage=function(t){f(t.data)},s=function(t){o.port2.postMessage(t)}):u&&"onreadystatechange"in u.createElement("script")?(n=u.documentElement,s=function(t){var e=u.createElement("script");e.onreadystatechange=function(){f(t),e.onreadystatechange=null,n.removeChild(e),e=null},n.appendChild(e)}):s=function(t){setTimeout(f,0,t)}:(r="setImmediate$"+Math.random()+"$",a=function(e){e.source===t&&"string"==typeof e.data&&0===e.data.indexOf(r)&&f(+e.data.slice(r.length))},t.addEventListener?t.addEventListener("message",a,!1):t.attachEvent("onmessage",a),s=function(e){t.postMessage(r+e,"*")}),p.setImmediate=function(t){"function"!=typeof t&&(t=new Function(""+t));for(var e=new Array(arguments.length-1),i=0;i<e.length;i++)e[i]=arguments[i+1];var n={callback:t,args:e};return l[h]=n,s(h),h++},p.clearImmediate=d}function d(t){delete l[t]}function f(t){if(c)setTimeout(f,0,t);else{var e=l[t];if(e){c=!0;try{!function(t){var e=t.callback,s=t.args;switch(s.length){case 0:e();break;case 1:e(s[0]);break;case 2:e(s[0],s[1]);break;case 3:e(s[0],s[1],s[2]);break;default:e.apply(i,s)}}(e)}finally{d(t),c=!1}}}}}("undefined"==typeof self?void 0===t?this:t:self)}).call(this,i(0),i(4))},function(t,e){var i,s,n=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function a(t){if(i===setTimeout)return setTimeout(t,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:o}catch(t){i=o}try{s="function"==typeof clearTimeout?clearTimeout:r}catch(t){s=r}}();var h,l=[],c=!1,u=-1;function p(){c&&h&&(c=!1,h.length?l=h.concat(l):u=-1,l.length&&d())}function d(){if(!c){var t=a(p);c=!0;for(var e=l.length;e;){for(h=l,l=[];++u<e;)h&&h[u].run();u=-1,e=l.length}h=null,c=!1,function(t){if(s===clearTimeout)return clearTimeout(t);if((s===r||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(t);try{s(t)}catch(e){try{return s.call(null,t)}catch(e){return s.call(this,t)}}}(t)}}function f(t,e){this.fun=t,this.array=e}function y(){}n.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];l.push(new f(t,e)),1!==l.length||c||a(d)},f.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=y,n.addListener=y,n.once=y,n.off=y,n.removeListener=y,n.removeAllListeners=y,n.emit=y,n.prependListener=y,n.prependOnceListener=y,n.listeners=function(t){return[]},n.binding=function(t){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(t){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},function(t,e,i){"use strict";i.r(e);i(1);var s={abs:function(t){return t<0?-t:t},boundary:function(t,e,i){return Math.min(Math.max(t,e),i)},degToRad:function(t){return t*Math.PI/180},radToDeg:function(t){return 180*t/Math.PI},distance:function(t,e,i,s){return Math.sqrt((i-t)*(i-t)+(s-e)*(s-e))},map:function(t,e,i,s,n){return s+(n-s)*(t-e)/(i-e)}};function n(t,e,i,s){var n;n=e?new o(t,0,i,s):new r(t,0,i,s),this.root=n}function o(t,e,i,s){this._bounds=t,this.children=[],this.nodes=[],s&&(this._maxChildren=s),i&&(this._maxDepth=i),e&&(this._depth=e)}function r(t,e,i,s){o.call(this,t,e,i,s),this._stuckChildren=[]}function a(t,e){this.x=t||0,this.y=e||0}n.prototype.root=null,n.prototype.insert=function(t){if(t instanceof Array){var e,i=t.length;for(e=0;e<i;e++)this.root.insert(t[e])}else this.root.insert(t)},n.prototype.clear=function(){this.root.clear()},n.prototype.retrieve=function(t){return this.root.retrieve(t).slice(0)},o.prototype.nodes=null,o.prototype._classConstructor=o,o.prototype.children=null,o.prototype._bounds=null,o.prototype._depth=0,o.prototype._maxChildren=4,o.prototype._maxDepth=4,o.TOP_LEFT=0,o.TOP_RIGHT=1,o.BOTTOM_LEFT=2,o.BOTTOM_RIGHT=3,o.prototype.insert=function(t){if(this.nodes.length){var e=this._findIndex(t);this.nodes[e].insert(t)}else{this.children.push(t);var i=this.children.length;if(!(this._depth>=this._maxDepth)&&i>this._maxChildren){var s;for(this.subdivide(),s=0;s<i;s++)this.insert(this.children[s]);this.children.length=0}}},o.prototype.retrieve=function(t){if(this.nodes.length){var e=this._findIndex(t);return this.nodes[e].retrieve(t)}return this.children},o.prototype._findIndex=function(t){var e=this._bounds,i=!(t.x>e.x+e.width/2),s=!(t.y>e.y+e.height/2),n=o.TOP_LEFT;return i?s||(n=o.BOTTOM_LEFT):n=s?o.TOP_RIGHT:o.BOTTOM_RIGHT,n},o.prototype.subdivide=function(){var t=this._depth+1,e=this._bounds.x,i=this._bounds.y,s=this._bounds.width/2,n=this._bounds.height/2,r=e+s,a=i+n;this.nodes[o.TOP_LEFT]=new this._classConstructor({x:e,y:i,width:s,height:n},t,this._maxDepth,this._maxChildren),this.nodes[o.TOP_RIGHT]=new this._classConstructor({x:r,y:i,width:s,height:n},t,this._maxDepth,this._maxChildren),this.nodes[o.BOTTOM_LEFT]=new this._classConstructor({x:e,y:a,width:s,height:n},t,this._maxDepth,this._maxChildren),this.nodes[o.BOTTOM_RIGHT]=new this._classConstructor({x:r,y:a,width:s,height:n},t,this._maxDepth,this._maxChildren)},o.prototype.clear=function(){this.children.length=0;var t,e=this.nodes.length;for(t=0;t<e;t++)this.nodes[t].clear();this.nodes.length=0},r.prototype=new o,r.prototype._classConstructor=r,r.prototype._stuckChildren=null,r.prototype._out=[],r.prototype.insert=function(t){if(this.nodes.length){var e=this._findIndex(t),i=this.nodes[e];t.x>=i._bounds.x&&t.x+t.width<=i._bounds.x+i._bounds.width&&t.y>=i._bounds.y&&t.y+t.height<=i._bounds.y+i._bounds.height?this.nodes[e].insert(t):this._stuckChildren.push(t)}else{this.children.push(t);var s=this.children.length;if(!(this._depth>=this._maxDepth)&&s>this._maxChildren){var n;for(this.subdivide(),n=0;n<s;n++)this.insert(this.children[n]);this.children.length=0}}},r.prototype.getChildren=function(){return this.children.concat(this._stuckChildren)},r.prototype.retrieve=function(t){var e=this._out;if(e.length=0,this.nodes.length){var i=this._findIndex(t),s=this.nodes[i];t.x>=s._bounds.x&&t.x+t.width<=s._bounds.x+s._bounds.width&&t.y>=s._bounds.y&&t.y+t.height<=s._bounds.y+s._bounds.height?e.push.apply(e,this.nodes[i].retrieve(t)):(t.x<=this.nodes[o.TOP_RIGHT]._bounds.x&&(t.y<=this.nodes[o.BOTTOM_LEFT]._bounds.y&&e.push.apply(e,this.nodes[o.TOP_LEFT].getAllContent()),t.y+t.height>this.nodes[o.BOTTOM_LEFT]._bounds.y&&e.push.apply(e,this.nodes[o.BOTTOM_LEFT].getAllContent())),t.x+t.width>this.nodes[o.TOP_RIGHT]._bounds.x&&(t.y<=this.nodes[o.BOTTOM_RIGHT]._bounds.y&&e.push.apply(e,this.nodes[o.TOP_RIGHT].getAllContent()),t.y+t.height>this.nodes[o.BOTTOM_RIGHT]._bounds.y&&e.push.apply(e,this.nodes[o.BOTTOM_RIGHT].getAllContent())))}return e.push.apply(e,this._stuckChildren),e.push.apply(e,this.children),e},r.prototype.getAllContent=function(){var t,e=this._out;if(this.nodes.length)for(t=0;t<this.nodes.length;t++)this.nodes[t].getAllContent();return e.push.apply(e,this._stuckChildren),e.push.apply(e,this.children),e},r.prototype.clear=function(){this._stuckChildren.length=0,this.children.length=0;var t=this.nodes.length;if(t){var e;for(e=0;e<t;e++)this.nodes[e].clear();this.nodes.length=0}},a.prototype.copy=a.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this},a.prototype.clone=a.prototype.clone=function(){return new a(this.x,this.y)},a.prototype.perp=a.prototype.perp=function(){var t=this.x;return this.x=this.y,this.y=-t,this},a.prototype.rotate=a.prototype.rotate=function(t){var e=this.x,i=this.y;return this.x=e*Math.cos(t)-i*Math.sin(t),this.y=e*Math.sin(t)+i*Math.cos(t),this},a.prototype.reverse=a.prototype.reverse=function(){return this.x=-this.x,this.y=-this.y,this},a.prototype.normalize=a.prototype.normalize=function(){var t=this.len();return t>0&&(this.x=this.x/t,this.y=this.y/t),this},a.prototype.add=a.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},a.prototype.sub=a.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this},a.prototype.scale=a.prototype.scale=function(t,e){return this.x*=t,this.y*=void 0!==e?e:t,this},a.prototype.project=a.prototype.project=function(t){var e=this.dot(t)/t.len2();return this.x=e*t.x,this.y=e*t.y,this},a.prototype.projectN=a.prototype.projectN=function(t){var e=this.dot(t);return this.x=e*t.x,this.y=e*t.y,this},a.prototype.reflect=a.prototype.reflect=function(t){var e=this.x,i=this.y;return this.project(t).scale(2),this.x-=e,this.y-=i,this},a.prototype.reflectN=a.prototype.reflectN=function(t){var e=this.x,i=this.y;return this.projectN(t).scale(2),this.x-=e,this.y-=i,this},a.prototype.dot=a.prototype.dot=function(t){return this.x*t.x+this.y*t.y},a.prototype.len2=a.prototype.len2=function(){return this.dot(this)},a.prototype.len=a.prototype.len=function(){return Math.sqrt(this.len2())};var h={Sprite:class{constructor(t,e){if(this.size={x:e.tilewidth,y:e.tileheight},this.frame,this.grid=[],this.image=e.image,this.object=t,this.style=e.style,this.fixture=t.fixture,this.position=t.state.position,e.frames=e.frames||[0],this.image instanceof Image)for(let t=0;t<this.image.height;t+=this.size.y)for(let e=0;e<this.image.width;e+=this.size.x)this.grid.push({x:e,y:t});this.animation={frames:e.frames}}update(){this.frame=this.animation.frames.shift(),this.animation.frames.push(this.frame)}render(){let t=this.object,e=this.image,i=t.context;switch(i.fillStyle=this.style.fillStyle,i.lineWidth=this.style.lineWidth,i.strokeStyle=this.style.strokeStyle,i.lineJoin="miter",t.fixture.type){case"circle":{i.save(),i.beginPath(),i.ellipse(t.state.position.x,t.state.position.y,t.fixture.r,t.fixture.r,0,0,2*Math.PI),i.clip();let s=this.frame;e instanceof Image?i.drawImage(this.image,this.grid[s].x,this.grid[s].y,this.size.x,this.size.y,t.state.position.x-t.fixture.r,t.state.position.y-t.fixture.r,this.size.x,this.size.y):(i.fill(),i.stroke()),i.closePath(),i.restore();break}case"polygon":{i.save(),i.beginPath(),i.moveTo(t.state.position.x+t.fixture.points[0].x,t.state.position.y+t.fixture.points[0].y);for(let e=1;e<t.fixture.points.length;e++){let s=t.fixture.points[e];i.lineTo(t.state.position.x+s.x,t.state.position.y+s.y)}i.lineTo(t.state.position.x+t.fixture.points[0].x,t.state.position.y+t.fixture.points[0].y),i.clip();let s=this.frame;e instanceof Image?i.drawImage(this.image,this.grid[s].x,this.grid[s].y,this.size.x,this.size.y,t.state.position.x,t.state.position.y,this.size.x,this.size.y):(i.fill(),i.stroke()),i.closePath(),i.restore();break}}}}};class l{constructor(t){let e=a,i=Number,s=Object,n=String,o=Array;t.debug=t.debug||!1,t.position=t.position||new e,t.angle=t.angle||new i,t.maxVelocity=t.maxVelocity||new e(200,200),t.velocity=t.velocity||new e,t.acceleration=t.acceleration||new e,t.mass=t.mass||new i(1),t.force=t.force||new e,t.texture=t.texture||new s({}),t.texture.style=t.texture.style||new s({}),t.texture.style.fillStyle=t.texture.style.fillStyle||new n("#ddd"),t.texture.style.lineWidth=t.texture.style.lineWidth||new i(2),t.texture.style.strokeStyle=t.texture.style.strokeStyle||new n("#333"),this.debug=t.debug,this.state={},this.state.position=t.position,this.state.angle=t.angle,t.collision=t.collision||new s({}),t.collision.collides=t.collision.collides||!0,t.collision.group=t.collision.group||new o(["everyone"]),t.collision.checkAgenist=t.collision.checkAgenist||new o(["everyone"]),t.gravityFactor=t.gravityFactor||new e(1,1),this.collision={collides:t.collision.collides,group:t.collision.group,checkAgenist:t.collision.checkAgenist},this.state.force=t.force,this.gravityFactor=t.gravityFactor,this.state.mass=t.mass,this.state.maxVelocity=t.maxVelocity,this.state.velocity=t.velocity,this.state.acceleration=t.acceleration,this.types={kinematic:"kinematic",dynamic:"dynamic"},this.type=t.type,this.fixture={},this.texture=new h.Sprite(this,t.texture)}update(){}render(){let t=this.texture.style,e=this.context;if(this.debug){e.save(),e.beginPath(),e.strokeStyle="red",e.lineWidth="1";let t=this.fixture.getAABB().edges,i=(t[0].x-t[2].x)/2,s=(t[1].y-t[3].y)/2,n=this.state.position,o=n.x,r=n.y;"circle"==this.fixture.type&&(o=n.x-i/2,r=n.y-s/2),e.rect(o,r,i,s),e.stroke(),e.restore()}e.fillStyle=t.fillStyle,e.lineWidth=t.lineWidth,e.strokeStyle=t.strokeStyle,e.lineJoin="miter"}}class c{constructor(t,e){var i={delta:1e3/e,elapsed:0,tframe:1e3/e,nframe:e,before:window.performance.now(),main:function(){i.startLoop=window.requestAnimationFrame(i.main),i.delta=Math.round(1e3/(window.performance.now()-i.before)*100/100),window.performance.now()<i.before+i.tframe||(i.before=window.performance.now(),i.stopLoop=()=>{window.cancelAnimationFrame(i.startLoop)},t.state&&(t.state.loop=i),t.update(i.elapsed,i.delta),t.render(i.elapsed,i.delta),i.elapsed++)}};return i.main(),i}}class u{constructor(t,e,i){i=document.querySelector(i||"body");var s=document.createElement("canvas"),n=s.getContext("2d"),o=window.devicePixelRatio/["webkitBackingStorePixelRatio","mozBackingStorePixelRatio","msBackingStorePixelRatio","oBackingStorePixelRatio","backingStorePixelRatio"].reduce(function(t,e){return Object.prototype.hasOwnProperty.call(n,e)?n[e]:1});return s.width=Math.round(t*o),s.height=Math.round(e*o),s.style.width=t+"px",s.style.height=e+"px",n.setTransform(o,0,0,o,0,0),i.insertBefore(s,i.firstChild),s.context=s.getContext("2d"),s.resize=(t,e)=>{s.style.width=e.x+"px",s.style.height=e.y+"px",s.width=Math.round(e.x*o),s.height=Math.round(e.y*o),n.setTransform(o,0,0,o,0,0),t.state.size.x=e.x,t.state.size.y=e.y},s.clear=(t,e,i,n,o)=>{t=t||null,e=e||0,i=i||0,n=n||s.width,o=o||s.height,t?(s.context.save(),s.context.fillStyle=t,s.context.fillRect(e,i,n,o),s.context.fill(),s.context.restore()):s.context.clearRect(e,i,n,o)},s.camera=(t,e)=>{s.context.setTransform(1,0,0,1,0,0),s.context.translate(-t,-e)},s}}class p{constructor(t,e){this.type="polygon",this.pos=t||new a,this.angle=0,this.offset=new a,this.setPoints(e||[])}setPoints(t){if(!this.points||this.points.length!==t.length){var e,i=this.calcPoints=[],s=this.edges=[],n=this.normals=[];for(e=0;e<t.length;e++){var o=t[e],r=e<t.length-1?t[e+1]:t[0];o===r||o.x!==r.x||o.y!==r.y?(i.push(new a),s.push(new a),n.push(new a)):(t.splice(e,1),e-=1)}}return this.points=t,this._recalc(),this}setAngle(t){return this.angle=t,this._recalc(),this}setOffset(t){return this.offset=t,this._recalc(),this}rotate(t){for(var e=this.points,i=e.length,s=0;s<i;s++)e[s].rotate(t);return this._recalc(),this}translate(t,e){for(var i=this.points,s=i.length,n=0;n<s;n++)i[n].x+=t,i[n].y+=e;return this._recalc(),this}_recalc(){var t,e=this.calcPoints,i=this.edges,s=this.normals,n=this.points,o=this.offset,r=this.angle,a=n.length;for(t=0;t<a;t++){var h=e[t].copy(n[t]);h.x+=o.x,h.y+=o.y,0!==r&&h.rotate(r)}for(t=0;t<a;t++){var l=e[t],c=t<a-1?e[t+1]:e[0],u=i[t].copy(c).sub(l);s[t].copy(u).perp().normalize()}return this}getAABB(){for(var t=this.calcPoints,e=t.length,i=t[0].x,s=t[0].y,n=t[0].x,o=t[0].y,r=1;r<e;r++){var h=t[r];h.x<i?i=h.x:h.x>n&&(n=h.x),h.y<s?s=h.y:h.y>o&&(o=h.y)}return new d(this.pos.clone().add(new a(i,s)),n-i,o-s).toPolygon()}getCentroid(){for(var t=this.calcPoints,e=t.length,i=0,s=0,n=0,o=0;o<e;o++){var r=t[o],h=o===e-1?t[0]:t[o+1],l=r.x*h.y-h.x*r.y;i+=(r.x+h.x)*l,s+=(r.y+h.y)*l,n+=l}return new a(i/=n*=3,s/=n)}}class d{constructor(t,e,i){this.pos=t||new a,this.w=e||0,this.h=i||0}toPolygon(){var t=this.pos,e=this.w,i=this.h;return new p(new a(t.x,t.y),[new a,new a(e,0),new a(e,i),new a(0,i)])}}class f{constructor(t,e){this.type="circle",this.pos=t||new a,this.r=e||0,this.offset=new a}getAABB(){var t=this.r,e=this.pos.clone().add(this.offset).sub(new a(t,t));return new d(e,2*t,2*t).toPolygon()}getCentroid(){let t=this.getAABB(),e=t.edges[3].x,i=t.edges[2].y;return new a((t.edges[0].x-e)/2,(t.edges[1].y-i)/2)}setOffset(t){return this.offset=t,this}}var y={Circle:f,Polygon:p};class x{constructor(t,e,i){let s=Number,n=Object,o=String;this.state={},this.collision={collides:!0},this.type="kinematic",this.context=t,(e=e||new n({})).style=e.style||new n({}),e.style.fillStyle=e.style.fillStyle||new o("#ddd"),e.style.lineWidth=e.style.lineWidth||new s(2),e.style.strokeStyle=e.style.strokeStyle||new o("#333"),e.frames=[Math.floor(i[0])],this.state.position=new a(e.tilewidth*i[1],e.tileheight*i[2]),this.fixture=new y.Polygon(this.state.position,[{x:0,y:0},{x:0,y:e.tileheight},{x:e.tilewidth,y:e.tileheight},{x:e.tilewidth,y:0}]),this.texture=new h.Sprite(this,e)}}class g{constructor(t,e,i){this.tilemaps=[],this.level=null,this.quad=i,this.pool=[],this.context=e}__load(t){let e=[];this.pool=[],t.tilesets.forEach(t=>{e.push(t)}),t.layers.forEach(t=>{t.data.forEach(t=>{let i=e[t[3]],s=new Image;s.src=i.image,s.onload=()=>{i.image=s;let e=new x(this.context,i,t);this.quad.insert(e),this.pool.push(e)}})})}load(t,e){this.tilemaps[e]=t}set(t){this.tilemaps[t]&&this.__load(this.tilemaps[t])}update(t){this.pool.forEach(t=>{let e=t,i=e.fixture.getAABB().edges,s=(i[0].x-i[2].x)/2,n=(i[1].y-i[3].y)/2,o=e.state.position,r=o.x,a=o.y;"circle"==e.fixture.type&&(r=o.x-s/2,a=o.y-n/2),this.quad.insert({x:r,y:a,width:s,height:n,item:e}),e.texture.update()})}render(t){this.pool.forEach(t=>{t.texture.render()})}}class m{static collides(t,e){return!(!t.collision.collides||!e.collision.collides)}static query(t,e){let i=[];return e.retrieve(t).forEach(t=>{i.push(t.item)}),i}}var v={AABB:d,Circle:f,Polygon:p};function w(){this.a=null,this.b=null,this.overlapN=new a,this.overlapV=new a,this.clear()}v.Response=w,w.prototype.clear=w.prototype.clear=function(){return this.aInB=!0,this.bInA=!0,this.overlap=Number.MAX_VALUE,this};for(var b=[],_=0;_<10;_++)b.push(new a);var T=[];for(_=0;_<5;_++)T.push([]);var I=new w,P=new d(new a,1e-6,1e-6).toPolygon();function O(t,e,i){for(var s=Number.MAX_VALUE,n=-Number.MAX_VALUE,o=t.length,r=0;r<o;r++){var a=t[r].dot(e);a<s&&(s=a),a>n&&(n=a)}i[0]=s,i[1]=n}function M(t,e,i,s,n,o){var r=T.pop(),a=T.pop(),h=b.pop().copy(e).sub(t),l=h.dot(n);if(O(i,n,r),O(s,n,a),a[0]+=l,a[1]+=l,r[0]>a[1]||a[0]>r[1])return b.push(h),T.push(r),T.push(a),!0;if(o){var c,u,p=0;if(r[0]<a[0])if(o.aInB=!1,r[1]<a[1])p=r[1]-a[0],o.bInA=!1;else p=(c=r[1]-a[0])<(u=a[1]-r[0])?c:-u;else if(o.bInA=!1,r[1]>a[1])p=r[0]-a[1],o.aInB=!1;else p=(c=r[1]-a[0])<(u=a[1]-r[0])?c:-u;var d=Math.abs(p);d<o.overlap&&(o.overlap=d,o.overlapN.copy(n),p<0&&o.overlapN.reverse())}return b.push(h),T.push(r),T.push(a),!1}function A(t,e){var i=t.len2(),s=e.dot(t);return s<0?C:s>i?S:k}v.isSeparatingAxis=M;var C=-1,k=0,S=1;function B(t,e,i){for(var s=b.pop().copy(e.pos).add(e.offset).sub(t.pos),n=e.r,o=n*n,r=t.calcPoints,a=r.length,h=b.pop(),l=b.pop(),c=0;c<a;c++){var u=c===a-1?0:c+1,p=0===c?a-1:c-1,d=0,f=null;h.copy(t.edges[c]),l.copy(s).sub(r[c]),i&&l.len2()>o&&(i.aInB=!1);var y=A(h,l);if(y===C){h.copy(t.edges[p]);var x=b.pop().copy(s).sub(r[p]);if((y=A(h,x))===S){if((m=l.len())>n)return b.push(s),b.push(h),b.push(l),b.push(x),!1;i&&(i.bInA=!1,f=l.normalize(),d=n-m)}b.push(x)}else if(y===S){if(h.copy(t.edges[u]),l.copy(s).sub(r[u]),(y=A(h,l))===C){if((m=l.len())>n)return b.push(s),b.push(h),b.push(l),!1;i&&(i.bInA=!1,f=l.normalize(),d=n-m)}}else{var g=h.perp().normalize(),m=l.dot(g),v=Math.abs(m);if(m>0&&v>n)return b.push(s),b.push(g),b.push(l),!1;i&&(f=g,d=n-m,(m>=0||d<2*n)&&(i.bInA=!1))}f&&i&&Math.abs(d)<Math.abs(i.overlap)&&(i.overlap=d,i.overlapN.copy(f))}return i&&(i.a=t,i.b=e,i.overlapV.copy(i.overlapN).scale(i.overlap)),b.push(s),b.push(h),b.push(l),!0}function E(t,e,i){for(var s=t.calcPoints,n=s.length,o=e.calcPoints,r=o.length,a=0;a<n;a++)if(M(t.pos,e.pos,s,o,t.normals[a],i))return!1;for(a=0;a<r;a++)if(M(t.pos,e.pos,s,o,e.normals[a],i))return!1;return i&&(i.a=t,i.b=e,i.overlapV.copy(i.overlapN).scale(i.overlap)),!0}v.pointInCircle=function(t,e){var i=b.pop().copy(t).sub(e.pos).sub(e.offset),s=e.r*e.r,n=i.len2();return b.push(i),n<=s},v.pointInPolygon=function(t,e){P.pos.copy(t),I.clear();var i=E(P,e,I);return i&&(i=I.aInB),i},v.testCircleCircle=function(t,e,i){var s=b.pop().copy(e.pos).add(e.offset).sub(t.pos).sub(t.offset),n=t.r+e.r,o=n*n,r=s.len2();if(r>o)return b.push(s),!1;if(i){var a=Math.sqrt(r);i.a=t,i.b=e,i.overlap=n-a,i.overlapN.copy(s.normalize()),i.overlapV.copy(s).scale(i.overlap),i.aInB=t.r<=e.r&&a<=e.r-t.r,i.bInA=e.r<=t.r&&a<=t.r-e.r}return b.push(s),!0},v.testPolygonCircle=B,v.testCirclePolygon=function(t,e,i){var s=B(e,t,i);if(s&&i){var n=i.a,o=i.aInB;i.overlapN.reverse(),i.overlapV.reverse(),i.a=i.b,i.b=n,i.aInB=i.bInA,i.bInA=o}return s},v.testPolygonPolygon=E;var z=v;class j{static overlap(t,e){return!0}static query(t,e){let i=[];return e.forEach(e=>{this.overlap(e,t)&&i.push(e)}),i}}class F{constructor(){this.response=new z.Response}resolve(t,e){e.forEach(e=>{let i;(i=e.fixture instanceof f?t.fixture instanceof f?z.testCircleCircle(e.fixture,t.fixture,this.response):z.testCirclePolygon(e.fixture,t.fixture,this.response):t.fixture instanceof f?z.testPolygonCircle(e.fixture,t.fixture,this.response):z.testPolygonPolygon(e.fixture,t.fixture,this.response))&&("kinematic"==e.type?(t.state.position.add(this.response.overlapV),t.state.velocity.add(this.response.overlapV)):"kinematic"==t.type?(e.state.position.sub(this.response.overlapV),e.state.velocity.sub(this.response.overlapV)):(this.response.overlapV.scale(.5),e.state.position.sub(this.response.overlapV),t.state.position.add(this.response.overlapV),e.state.velocity.sub(this.response.overlapV),t.state.velocity.add(this.response.overlapV))),this.response.clear()})}}class q{constructor(t){t.entities=t.entities||[],t.size=t.size||new a(1e3,500),t.gravity=t.gravity||new a,t.quad=t.quad||new a,t.resources=t.resources||{},t.resources.image=t.resources.image||[],t.resources.audio=t.resources.audio||[],t.resources.data=t.resources.data||[],t.fps=t.fps||60,t.debug=t.debug||!1,this.entities=t.entities,this.debug=t.debug,this.state={size:t.size,gravity:t.gravity},this.viewport=new u(this.state.size.x,this.state.size.y,t.container),this.context=this.viewport.context,this.quad=new n({x:t.quad.x,y:t.quad.y,width:t.size.x,height:t.size.y}),this.solver=new F,this.tilemap=new g(t.tilemap,this.context,this.quad),this.loop=new c(this,t.fps),window.cg=this}addObject(t){return t.context=this.context,this.entities.push(t)}removeObject(t){return this.entities.splice(t,1)}update(){this.quad.clear(),this.tilemap.update(),this.entities.forEach(t=>{let e=t,i=e.fixture.getAABB().edges,s=(i[0].x-i[2].x)/2,n=(i[1].y-i[3].y)/2,o=e.state.position,r=o.x,a=o.y;"circle"==e.fixture.type&&(r=o.x-s/2,a=o.y-n/2),this.quad.insert({x:r,y:a,width:s,height:n,item:e});let h=m.query(t,this.quad),l=j.query(t,h);this.solver.resolve(t,l);let c=this.state.gravity.clone().scale(t.gravityFactor.x,t.gravityFactor.y);t.state.mass;t.state.acceleration.add(c),t.state.velocity.add(t.state.acceleration),t.state.velocity.x=Math.min(t.state.velocity.x,t.state.maxVelocity.x),t.state.velocity.y=Math.min(t.state.velocity.y,t.state.maxVelocity.y),t.state.position.add(t.state.velocity.clone().scale(1/this.state.loop.nframe)),t.update()})}render(){if(this.viewport.clear(),this.tilemap.render(),this.debug){let t=this.quad.root,e=t=>{let i=t._bounds,n=(s.abs,this.context);n.save(),n.strokeStyle="green",n.lineWidth="2",n.beginPath(),n.rect(i.x,i.y,i.width,i.height);let o,r=t.getChildren(),a=r.length;if(a)for(let t=0;t<a;t++)o=r[t],n.beginPath(),n.rect(o.x,o.y,o.width,o.height);let h=t.nodes.length;for(let i=0;i<h;i++)e(t.nodes[i]);n.stroke(),n.restore()};e(t)}this.entities.forEach(t=>{t.render(),t.texture.update(),t.texture.render()})}}class L extends q{constructor(t,e,i){super({fps:60,debug:!1,container:"#container",size:new a(500,500)}),this.score="0000",this.viewport.resize(this,{x:window.innerWidth,y:window.innerHeight});for(var s=0;s<15;s++)this.addObject(new N(this));this.addObject(new V(this))}render(){super.render(),this.context.font="2em Arial",this.context.fillStyle="#fff",this.context.fillText("score: "+this.score,16,50)}}class R extends l{constructor(t,e,i,s){super({debug:!1,texture:{style:{fillStyle:"red",strokeStyle:"white"},frames:[0,1,2],tileheight:s,tilewidth:i,image:e}}),this.state.position.x=Math.random()*t.state.size.x,this.state.position.y=Math.random()*t.state.size.y,this.fixture=new y.Polygon(this.state.position,[{x:0,y:0},{x:0,y:s},{x:i,y:s},{x:i,y:0}]),this.state.angle=360*Math.random()}}class V extends R{constructor(t,e){super(t,H.fetch("./media/bug.png"),196,218)}}class N extends R{constructor(t,e){super(t,H.fetch("./media/bolt.png"),214,282)}}var H=new class{constructor(){this.instances={}}load(t,e){if(t instanceof Array){if(t.length<0)return this.ready(e);t.forEach(t=>{this.instances[t]=!1,this.fetch(t,e)})}else this.instances[t]=!1,this.fetch(t,e)}fetch(t,e){if(this.instances[t])return this.instances[t];{let i=new Image;i.onload=()=>{this.instances[t]=i,this.ready(e)},i.src=t}}ready(t){if("function"==typeof t){let e=!0;for(let t in this.instances)Object.prototype.hasOwnProperty.call(this.instances,t)&&!this.instances[t]&&(e=!1);e&&t()}}};H.load(["./media/bug.png","./media/bolt.png"],function(){window.game=new L("#container",window.innerWidth,window.innerHeight,60,!0)})}]);